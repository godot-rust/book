<!--
  ~ Copyright (c) godot-rust; Bromeon and contributors.
  ~ This Source Code Form is subject to the terms of the Mozilla Public
  ~ License, v. 2.0. If a copy of the MPL was not distributed with this
  ~ file, You can obtain one at https://mozilla.org/MPL/2.0/.
-->

# Migrating to v0.5

This guide covers deprecations and breaking changes when upgrading from godot-rust 0.4 to 0.5.

```admonish tip title="Smooth transition"
To reduce the friction, we recommend first updating to the latest patch release of the previous minor version, v0.4.5.
Many changes are announced early in the form of deprecation warnings, which contain instructions on how to switch to newer APIs.

You can update your `Cargo.toml` to the latest patch release by running:
~~~bash
cargo update -p godot
~~~
Once you have addressed all deprecation warnings, you can update to the new minor version:
~~~bash
cargo upgrade -p godot
~~~
```


## Table of contents
<!-- toc -->


## Godot versions

[#1484]: godot-rust v0.5 adds **API level 4.6**, which is now the new default.

This doesn't mean you have to update your Godot version -- just provide Cargo features to use older API levels, e.g. `api-4-5`.


[#1484]: https://github.com/godot-rust/gdext/pull/1484


## Removed deprecated symbols

[#1459]: All symbols that were deprecated during the v0.4 cycle have been removed. If you have already addressed all deprecation warnings in
v0.4.5, you should not encounter issues. The following table lists the removed symbols and their replacements:

| Removed symbol                                   | Replacement                                        |
|--------------------------------------------------|----------------------------------------------------|
| `VariantArray` (type alias)                      | `VarArray`                                         |
| `ClassName` (type alias)                         | `ClassId`                                          |
| `GodotClass::class_name()`                       | `GodotClass::class_id()`                           |
| `WithBaseField::apply_deferred()`                | `run_deferred()` + <br>`run_deferred_gd()`         |
| `Gd::apply_deferred()`                           | `Gd::run_deferred()` + `Gd::run_deferred_gd()`     |
| `Callable::from_local_fn()`                      | `Callable::from_fn()`                              |
| `Callable::from_local_static()`                  | `Callable::from_class_static()`                    |
| `*::hash()` (Godot hash value)                   | `*::hash_u32()`                                    |
| `Array::bsearch_custom()`                        | `Array::functional_ops()`<br>`  .bsearch_custom()` |
| `ExtensionLibrary::on_level_init()`              | `ExtensionLibrary::on_stage_init()`                |
| `ExtensionLibrary::on_level_deinit()`            | `ExtensionLibrary::on_stage_deinit()`              |
| `ExtensionLibrary::on_main_loop_startup()`       | `on_stage_init(InitStage::MainLoop)`               |
| `ExtensionLibrary::on_main_loop_shutdown()`      | `on_stage_deinit(InitStage::MainLoop)`             |
| `#[class(no_init, base=EditorPlugin)]` (warning) | Now a hard compile error; use `#[class(init)]`     |

[#1459]: https://github.com/godot-rust/gdext/pull/1459


## Required objects in engine APIs

[#1383], [#1493]: GDExtension 4.6 provides non-null ("required") type information for function parameters and return types. This means that
many Rust APIs can now become more type-safe, and your code will not need to deal with `Option` in cases where values are not supposed to
be null.

**Before (0.4):**

```rust
let maybe_child: Option<Gd<Node>> = ...;
node.add_child(&maybe_child);

let tree = node.get_tree().unwrap();
let tween = node.create_tween().unwrap();
```

**After (0.5):**

```rust
// Option no longer compiles.
let definitely_child: Gd<Node> = ...; // non-null
node.add_child(&definitely_child);

let tree = node.get_tree(); // Panics if not in tree; otherwise get_tree_or_null().
let tween = node.create_tween();
```

[#1383]: https://github.com/godot-rust/gdext/pull/1383
[#1493]: https://github.com/godot-rust/gdext/pull/1493

## Property APIs

### `Var` trait redesign

[#1454], [#1458], [#1466], [#1469]: The `Var` trait has been redesigned to support `#[var(pub)]`, which generates typed Rust getters/setters
with clone-based semantics. The trait API changed as follows:

**Before (0.4):**

```rust
pub trait Var: GodotConvert {
    fn get_property(&self) -> Self::Via;
    fn set_property(&mut self, value: Self::Via);
    fn var_hint() -> PropertyHintInfo { ... }
}
```

**After (0.5):**

```rust
pub trait Var: GodotConvert {
    type PubType;
    fn var_get(field: &Self) -> Self::Via;
    fn var_set(field: &mut Self, value: Self::Via);
    fn var_pub_get(field: &Self) -> Self::PubType;
    fn var_pub_set(field: &mut Self, value: Self::PubType);
    fn var_hint() -> PropertyHintInfo { ... }
}
```

If you have manual `Var` implementations, you need to update them. However, for most cases, you can use the new [`SimpleVar`][api-simplevar]
marker trait instead: types implementing `SimpleVar` (which requires `ToGodot + FromGodot + Clone`) automatically get a standard `Var`
implementation via blanket impl.

**Before (0.4):**

```rust
impl Var for MyType {
    fn get_property(&self) -> Self::Via {
        self.to_godot_owned()
    }
    fn set_property(&mut self, value: Self::Via) {
        *self = FromGodot::from_godot(value);
    }
}
```

**After (0.5):**

```rust
// If MyType: ToGodot + FromGodot + Clone, just implement this:
impl SimpleVar for MyType {}
```

[api-simplevar]: https://godot-rust.github.io/docs/gdext/master/godot/register/property/trait.SimpleVar.html


#### `#[var]` getter/setter semantics

[#1454]: The `#[var(get, set)]` attribute now uses an orthogonal model. The behavior has changed:

- `#[var]` generates both getter and setter (same as before).
- `#[var(get)]` declares a custom getter with the default name `get_{field}`. Previously, this _disabled_ the setter.
- `#[var(set)]` declares a custom setter with the default name `set_{field}`. Previously, this _disabled_ the getter.
- `#[var(no_get)]` disables the getter (previously `#[var(set)]` implied this).
- `#[var(no_set)]` disables the setter (previously `#[var(get)]` implied this).
- `#[var(get = my_fn)]` and `#[var(set = my_fn)]` work as before with custom function names.

**Before (0.4):**

```rust
// Disabled setter, only getter:
#[var(get)]
my_field: i32,

// Disabled getter, only setter:
#[var(set)]
other_field: f32,
```

**After (0.5):**

```rust
// Disabled setter, only getter:
#[var(no_set)]
my_field: i32,

// Disabled getter, only setter:
#[var(no_get)]
other_field: f32,

// Custom getter, generated setter:
#[var(get)]
custom_get_field: i32,
```


#### `#[var(pub)]` for Rust-side accessors

[#1458], [#1466]: Auto-generated Rust getters/setters for `#[var]` fields are being phased out.  
In v0.4, `#[var]` fields implicitly generated public Rust accessor methods (e.g. `get_my_field()` / `set_my_field()`).
These are now deprecated and will be removed in v0.6.

If you rely on these generated Rust methods, opt in explicitly with `#[var(pub)]`:

```rust
#[var(pub)]
my_field: i32,
// Generates: fn get_my_field(&self) -> i32
//            fn set_my_field(&mut self, value: i32)
```

The `#[var(pub)]` accessors use `Clone`-based semantics (via `Var::PubType`), while the internal Godot-facing accessors continue to use
`GodotConvert::Via`.


#### Compile-time type checks for custom `#[var]` accessors

[#1469]: Custom getters and setters declared with `#[var(get)]` or `#[var(set)]` are now type-checked at compile time. If your getter's
return type or setter's parameter type doesn't match the field's `Var::PubType`, you'll get a compile error instead of a runtime failure.

[#1454]: https://github.com/godot-rust/gdext/pull/1454
[#1458]: https://github.com/godot-rust/gdext/pull/1458
[#1466]: https://github.com/godot-rust/gdext/pull/1466
[#1469]: https://github.com/godot-rust/gdext/pull/1469


### Const-qualified getters

[#1497]: A heuristic now const-qualifies Godot methods prefixed with `get_`, `is_`, or `has_`, changing their receiver from `&mut self` to
`&self`. This affects a large number of engine methods, which were unnecessarily declared mutable.

An explicit deny-list handles false positives: methods that actually mutate state remain `&mut self`. 
Examples: `FileAccess::get_line()` which advances a cursor, `StreamPeer::get_8()`, etc.

This is a technically breaking change, but existing code using `mut` bindings will continue to compile. Clippy may emit warnings about
unnecessary `mut`.

**Before (0.4):**

```rust
let mut api: Gd<MultiplayerApi> = ...;
let id = api.get_unique_id(); // Required &mut self.
```

**After (0.5):**

```rust
let api: Gd<MultiplayerApi> = ...;
let id = api.get_unique_id(); // Now takes &self.
```

[#1497]: https://github.com/godot-rust/gdext/pull/1497




### Raw pointer unification with `RawPtr<P>`

[#1436]: Raw pointers in engine APIs (native structures, `c_void`, etc.) are now wrapped in [`RawPtr<P>`][api-rawptr], replacing direct
`*const T` / `*mut T` parameters. Construction requires `unsafe`, which wasn't the case before -- you could previously return a pointer to a
local variable from `#[func]` without ever typing `unsafe`.

**Before (0.4):**

```rust
#[func]
fn pass_native_struct(&self, caret_info: *const CaretInfo) -> VarDictionary {
    let info = unsafe { &*caret_info };
    // ...
}

#[func]
fn native_struct_array_ret(&self) -> *const Glyph {
    self.glyphs.as_ptr()
}
```

**After (0.5):**

```rust
use godot::meta::RawPtr;

#[func]
fn pass_native_struct(&self, caret_info: RawPtr<*const CaretInfo>) -> VarDictionary {
    let info = unsafe { &*caret_info.ptr() };
    // ...
}

#[func]
fn native_struct_array_ret(&self) -> RawPtr<*const Glyph> {
    unsafe { RawPtr::new(self.glyphs.as_ptr()) }
}
```

[#1436]: https://github.com/godot-rust/gdext/pull/1436

[api-rawptr]: https://godot-rust.github.io/docs/gdext/master/godot/meta/struct.RawPtr.html


### `#[func]` compile-time type bounds

[#1435]: Parameters and return types in `#[func]` methods are now checked at compile time to ensure they implement `FromGodot` and `ToGodot`
respectively. Previously, types only implementing the internal `EngineFromGodot`/`EngineToGodot` traits (like raw pointers) could be used in
`#[func]`, which was unsound. Raw pointers and native structures can still be used in engine-facing APIs and virtual methods.

This also means that `u64` can no longer be used as a `#[func]` return type, since it doesn't implement `ToGodot` (use `i64` instead).

[#1435]: https://github.com/godot-rust/gdext/pull/1435


## New APIs


### `AnyArray` -- covariant typed/untyped array

[#1422], [#1434]: A new `AnyArray` type provides a type-erased array that can store either typed `Array<T>` or untyped `VarArray`. It is
covariant: any `&Array<T>` can be used where `&AnyArray` is expected, thanks to `Deref` coercion.

```rust
use godot::builtin::{Array, AnyArray, VarArray};

let typed: Array<i64> = array![1, 2, 3];

// Deref coercion: use typed array where AnyArray is expected.
let any_ref: &AnyArray = &typed;
assert_eq!(any_ref.len(), 3);

// Explicit upcast for owned values.
let any: AnyArray = typed.clone().upcast_any_array();

// Downcast back to typed.
let back: Array<i64> = any.try_cast_array::<i64>()
    .expect("convert back to typed");
```

Engine APIs that previously accepted `&VarArray` parameters (like `Callable::callv()`) now take `&AnyArray`, which means you can pass any
`&Array<T>` directly without manual conversion. If you were explicitly constructing a `VarArray` to pass to such methods, note that
`&VarArray` coerces to `&AnyArray` via `Deref`, so no changes should be necessary in most cases.

[#1422]: https://github.com/godot-rust/gdext/pull/1422
[#1434]: https://github.com/godot-rust/gdext/pull/1434


### Builder APIs for builtin methods

[#1424]: Builtin types (`GString`, `Vector2`, `Color`, etc.) now support the `_ex()` builder pattern for methods with default parameters,
consistent with how engine class methods already work.

**Before (0.4):**

```rust
let pi = GString::num(std::f64::consts::PI, 3);
```

**After (0.5):**

```rust
let pi = GString::num_ex(std::f64::consts::PI).decimals(3).done();
```

The non-`_ex` variants remain available and use Godot's default parameter values.

[#1424]: https://github.com/godot-rust/gdext/pull/1424


### Type-safe `duplicate_node()` and `duplicate_resource()`

[#1492]: New generic duplication methods return the concrete type instead of requiring manual downcasts.

```rust
let node: Gd<Node2D> = Node2D::new_alloc();
let copy: Gd<Node2D> = node.duplicate_node(); // Directly typed.

// Builder pattern for fine-grained control:
let copy = node.duplicate_node_ex()
    .flags(DuplicateFlags::SIGNALS | DuplicateFlags::GROUPS)
    .done();

let resource: Gd<Resource> = Resource::new_gd();
let copy: Gd<Resource> = resource.duplicate_resource();

// Deep duplication (Godot 4.5+):
let deep = resource.duplicate_resource_ex()
    .deep(DeepDuplicateMode::ALL)
    .done();
```

The old `Node::duplicate()` and `Resource::duplicate()` methods are deprecated in favor of these new type-safe variants.

[#1492]: https://github.com/godot-rust/gdext/pull/1492


### String equality with `&str`

[#1415], [#1420]: `GString` and `StringName` now support direct equality comparison with `&str`, avoiding temporary allocations.

```rust
let gs = GString::from("hello");
assert!(gs == "hello");

let sn = StringName::from("hello");
assert!(sn == "hello");
```

[#1415]: https://github.com/godot-rust/gdext/pull/1415
[#1420]: https://github.com/godot-rust/gdext/pull/1420


### `PackedArray` conversions

[#1433]: `Packed*Array` types gained `From<&[T]>` implementations, complementing the existing `From<Vec<T>>` and `From<&Array<T>>`.

```rust
let data: &[i32] = &[1, 2, 3];
let packed = PackedInt32Array::from(data);
```

[#1433]: https://github.com/godot-rust/gdext/pull/1433


### Engine enums in `PhantomVar` and `#[export]`

[#1438]: Engine-defined enums and bitfields now implement `Var` and `Export`, allowing them to be used directly in `#[var]` and `#[export]`
fields, as well as in `PhantomVar<T>`. `PhantomVar<T>` also relaxed its bounds from `GodotType` to `GodotConvert`.

```rust
#[derive(GodotClass)]
#[class(init, base=Node)]
struct MyNode {
    #[export]
    direction: Direction, // Engine enum, now works.

    base: Base<Node>,
}
```

[#1438]: https://github.com/godot-rust/gdext/pull/1438


### `DynGd::run_deferred()`

[#1451]: `DynGd<T, D>` now supports `run_deferred()`, analogous to `Gd<T>::run_deferred()`. This allows scheduling a deferred function call
on trait objects.

[#1451]: https://github.com/godot-rust/gdext/pull/1451


### Geometric API additions

[#1447], [#1461], [#1463]: Several geometric types gained new methods:

- `Aabb::get_endpoint()` -- returns a corner vertex of the bounding box.
- `Aabb` cleanup: additional methods like `get_center()` and `get_support()` (previously `support()`).
- `Rect2` / `Rect2i`: corner constructors and additional utility methods.

[#1447]: https://github.com/godot-rust/gdext/pull/1447
[#1461]: https://github.com/godot-rust/gdext/pull/1461
[#1463]: https://github.com/godot-rust/gdext/pull/1463


### Bitfield `Debug` formatting

[#1496]: Bitfield types now have a proper `Debug` implementation that prints named flags:

```rust
let flags = MethodFlags::NORMAL | MethodFlags::VIRTUAL;
// Debug output: "MethodFlags { NORMAL | VIRTUAL }"
// Previously: "MethodFlags(3)"
```

Note: the `EngineEnum` and `EngineBitfield` traits now additionally require `'static`. This is unlikely to affect user code, since all
enum/bitfield types are inherently `'static`.

[#1496]: https://github.com/godot-rust/gdext/pull/1496


### `u64` restricted to engine-only APIs

[#1413]: `u64` no longer implements `ToGodot`/`FromGodot` (only `EngineToGodot`/`EngineFromGodot`). This means `u64` can no longer be used
as a `#[func]` parameter or return type. Use `i64` instead. The change prevents silent truncation, since Godot's integer type is signed 64-bit.

`u64` continues to work in engine APIs where it appears in the Godot specification (e.g. `Object::get_instance_id()`).

[#1413]: https://github.com/godot-rust/gdext/pull/1413


## Other changes


### `GFile::read_as_gstring_entire()` parameter removed

[#1494]: The `skip_cr` parameter has been removed from `GFile::read_as_gstring_entire()` to provide a uniform API across Godot versions.

**Before (0.4):**

```rust
let text = gfile.read_as_gstring_entire(true)?;
```

**After (0.5):**

```rust
let text = gfile.read_as_gstring_entire()?;
```

[#1494]: https://github.com/godot-rust/gdext/pull/1494


### WASM support changes

[#1476]: The WASM initialization mechanism now uses `.init_array` instead of a JavaScript snippet. Only Emscripten-based WASM targets are
supported; non-Emscripten WASM targets will produce a compile error.

[#1476]: https://github.com/godot-rust/gdext/pull/1476


### `GdCell` mutex removal

[#1442]: `GdCell` internals no longer use a `Mutex`, improving performance for single-threaded access patterns. This is an internal change
with no API impact.

[#1442]: https://github.com/godot-rust/gdext/pull/1442
