<!--
  ~ Copyright (c) godot-rust; Bromeon and contributors.
  ~ This Source Code Form is subject to the terms of the Mozilla Public
  ~ License, v. 2.0. If a copy of the MPL was not distributed with this
  ~ file, You can obtain one at https://mozilla.org/MPL/2.0/.
-->

# Migrating to v0.4

This guide covers deprecations and breaking changes when upgrading from godot-rust 0.3 to 0.4.


## Table of contents
<!-- toc -->


## Godot version support

[#1292]: godot-rust v0.4 **drops support for Godot 4.1**.

The library now supports Godot versions 4.2 through 4.5, including the latest 4.5 release.  \
See also [_Compatibility and stability_][compat].

[compat]: ../toolchain/compatibility.md

[#1292]: https://github.com/godot-rust/gdext/pull/1292


## Overhauls to core APIs


### Argument passing redesign

[#1285], [#1308], [#1310], [#1314]: So far, [`AsArg`][api-asarg] and [`ToGodot`][api-togodot] traits have had very similar roles, namely converting
Rust types to Godot-compatible types. However, they had only limited interop. For example, it wasn't easily possible to pass user-defined enums to
`emit()` of signals.


#### `ToGodot::Pass` and automatic `AsArg` impls

The `ToGodot` trait has been simplified, replacing the associated type `ToVia<'v>` with `Pass`, which usually has one of two values.
`AsArg` is then auto-implemented for types that support `ToGodot`, in the following way:

- `Pass = ByValue`: what you typically want. This implements `AsArg<T>` for owned types `T`, e.g. you can pass `i64` directly to Godot.
- `Pass = ByRef` for specifically optimized types. This implements `AsArg<T>` for references `&T`, e.g. you can pass `&GString` to Godot
  without cloning. As a user, you typically need to convert to a custom type anyway, so `ByValue` is often easier.

If you follow those, you should never need to implement `AsArg` yourself. `ToGodot` is sufficient, and can often be derived.

**Before (0.3):**

```rust
impl ToGodot for MyString {
    type ToVia<'v> = Self::Via;

    fn to_godot(&self) -> Self::ToVia<'_> {
        GString::from(self)
    }
}
```

**After (0.4):**

```rust
use godot::meta;

impl ToGodot for MyString {
    type Pass = meta::ByValue;

    // Returns a new GString here, since we have to create one anyway.
    fn to_godot(&self) -> Self::Via {
        GString::from(self)
    }
}

impl ToGodot for MyCachedString {
    type Pass = meta::ByRef;

    // Returns &GString here, since we store a reference.
    fn to_godot(&self) -> &Self::Via {
        &self.cached_gstring
    }
}
```

[api-asarg]: https://godot-rust.github.io/docs/gdext/master/godot/meta/trait.AsArg.html
[api-togodot]: https://godot-rust.github.io/docs/gdext/master/godot/meta/trait.ToGodot.html


#### Return type changes

For reference-counted types (`GString`, `Array`, `Dictionary`, `Variant`...), `to_godot()` now returns references.
A value can be obtained by calling `to_godot_owned()`.

**Before (0.3):**

```rust
let a: GString = my_value.to_godot();
```

**After (0.4):**

```rust
let a: &GString = my_value.to_godot();
let b: GString = my_value.to_godot_owned();
```


#### Object argument traits

The specialized `AsObjectArg<T>` trait has been consolidated into the more general [`AsArg<Gd<T>>`][api-asarg] trait, unifying the type system.
It is also capable of expressing optional arguments through `AsArg<Option<Gd<T>>>`.

**Before (0.3):**


```rust
#[signal]
fn my_signal(some_node: Gd<Node>);
let node = Node::new_alloc();
let derived = Node2D::new_alloc();

// Argument had to be upcast.
sig.emit(&derived.upcast());

// The type could be inferred, but arguments had to be implicitly upcast.
let _array = array![&node, &derived.upcast()];
```

**After (0.4):**

```rust
fn my_signal(some_node: Gd<Node>);
let node = Node::new_alloc();
let derived = Node2D::new_alloc();

// Will be implicitly upcast.
sig.emit(&derived);

// Type must be specified, but arguments will be implicitly upcast.
let _array: Array<Gd<Node>> = array![&node, &derived];
```

[#1285]: https://github.com/godot-rust/gdext/pull/1285
[#1308]: https://github.com/godot-rust/gdext/pull/1308
[#1310]: https://github.com/godot-rust/gdext/pull/1310
[#1314]: https://github.com/godot-rust/gdext/pull/1314


### `Callable` return types

[#1332], [#1344], [#1346]: [`Callable`][api-callable] constructor `from_local_fn()` is phased out in favor of `from_fn()`, which supports any
return type implementing [`ToGodot`][api-togodot], eliminating the need for manual `Variant` conversion and wrapping inside `Result`.
The `Err` variant didn't add much purpose but required a lot of boilerplate, and errors can still be supported through panics or `RustCallable`
customization.

**Before (0.3):**

```rust
let callable = Callable::from_local_fn("answer", |args| {
    Ok(42.to_variant())
});

let callable = Callable::from_local_fn("unit", |args| {
    do_sth(args); // Some side effect, no return value.
    Ok(Variant::nil())
});
```

**After (0.4):**

```rust
let callable = Callable::from_fn("answer", |args| 42);

let callable = Callable::from_fn("unit", |args| {
    do_sth(args);
});
```

[#1332]: https://github.com/godot-rust/gdext/pull/1332
[#1344]: https://github.com/godot-rust/gdext/pull/1344
[#1346]: https://github.com/godot-rust/gdext/pull/1346

[api-callable]: https://godot-rust.github.io/docs/gdext/master/godot/builtin/struct.Callable.html


### `Singleton` trait

[#1325]: Singleton access has been moved to a dedicated [`Singleton`][api-singleton] trait, enabling generic programming while maintaining
backward compatibility with existing `singleton()` methods.

In the future, we may look into other options to provide singletons, especially once we support them for user classes, too.

**Before (0.3):**

```rust
let input = Input::singleton();
let engine = Engine::singleton();
```

**After (0.4):**

If you already include the prelude, no code changes should be necessary:

```rust
use godot::prelude::Singleton;

let input = Input::singleton(); // Still works
let engine = Engine::singleton(); // Still works

// Now supports generic access:
fn summon_the_one<T: Singleton>() -> Gd<T> {
    T::singleton()
}
```

[#1325]: https://github.com/godot-rust/gdext/pull/1325

[api-singleton]: https://godot-rust.github.io/docs/gdext/master/godot/obj/trait.Singleton.html


### Removed conversions

[#1286], [#1316]: By-value `From` conversions between string types have been removed to clarify that no buffer optimization occurs during conversion.
You can still use `From` for references.

**Before (0.3):**

```rust
let gstring = GString::from("hello");
let sname = StringName::from(gstring); // or .into()
```

**After (0.4):**

```rust
let gstring = GString::from("hello");
let sname = StringName::from(&gstring);
```

The `From<&'static CStr>` implementation for `StringName` has been removed, since Godot no longer offers a performance benefit,
and static storage duration may very easily cause memory leaks.

Furthermore, `impl From<VariantArray> for Packed*Array` has been removed. This was unsound; `VariantArray` can contain arbitrary types.

[#1286]: https://github.com/godot-rust/gdext/pull/1286
[#1316]: https://github.com/godot-rust/gdext/pull/1316


### Renames

- Struct `ClassName` -> [`ClassId`][api-classid], which represents the idea of lightweight IDs better.
- Method `apply_deferred()` -> [`run_deferred()`][api-gd-rundeferred] and [`run_deferred_gd()`][api-gd-rundeferredgd],
  accepting both `&mut T` and `Gd<T>` parameters.
- Method `Base::to_gd()` -> [`Base::to_init_gd()`][api-base-toinitgd], for proper access during `init`.
- Method `Callable::from_local_fn()` -> [`Callable::from_fn()`][api-callable-fromfn] (see above).
- Assoc fn `Callable::from_local_static()` -> [`Callable::from_class_static()`][api-callable-fromclassstatic].
- Trait `ToSignalObject` -> [`ObjectToOwned`][api-objecttoowned].
- Trait `WithDeferredCall` -> merged into [`WithBaseField`][api-withbasefield].

[api-classid]: https://godot-rust.github.io/docs/gdext/master/godot/meta/struct.ClassId.html
[api-gd-rundeferred]: https://godot-rust.github.io/docs/gdext/master/godot/obj/struct.Gd.html#method.run_deferred
[api-gd-rundeferredgd]: https://godot-rust.github.io/docs/gdext/master/godot/obj/struct.Gd.html#method.run_deferred_gd
[api-base-toinitgd]: https://godot-rust.github.io/docs/gdext/master/godot/obj/struct.Base.html#method.to_init_gd
[api-callable-fromfn]: https://godot-rust.github.io/docs/gdext/master/godot/builtin/struct.Callable.html#method.from_fn
[api-callable-fromclassstatic]: https://godot-rust.github.io/docs/gdext/master/godot/builtin/struct.Callable.html#method.from_class_static
[api-objecttoowned]: https://godot-rust.github.io/docs/gdext/master/godot/meta/trait.ObjectToOwned.html
[api-withbasefield]: https://godot-rust.github.io/docs/gdext/master/godot/obj/trait.WithBaseField.html


## Registration changes


### `#[export(range)]` limits and type validation

[#1320]: `#[export(range = ...)]` attribute traditionally required float literals, even for integer fields. The values were also not validated
against the field type, allowing out-of-bounds values.

Furthermore, reasonable range bounds are now inferred for all integer types.

**Before (0.3):**

```rust
#[export(range = (1.0, 500.0))]  // Float was required, no bound checks.
int_field: i8,

#[export]  // Default: full i64 range, allowing invalid values in editor.
another_field: i8,
```

**After (0.4):**

```rust
#[export(range = (1, 127))]  // Must be i8-compatible literals, within bounds.
int_field: i8,

#[export]  // Default: infer range from i8 as (-128, 127).
another_field: i8,
```

This change improves reliability, but may require updates to existing export declarations.

[#1320]: https://github.com/godot-rust/gdext/pull/1320


### Export range for radians

[#1320]: The `radians` option was deprecated in Godot itself, so the attribute was updated to use `radians_as_degrees`, which follows Godot's current
convention. Using the old `radians` will lead to a descriptive error.

**Before (0.3):**

```rust
#[export(range = (radians))]
angle: f32,
```

**After (0.4):**

```rust
#[export(range = (radians_as_degrees))]
angle: f32,
```

[#1320]: https://github.com/godot-rust/gdext/pull/1320


### Editor class validation

[#1272]: Classes with names starting with "Editor" must now be explicitly marked with the `internal` attribute to prevent accidental exposure in
exported builds. Godot has a special and undocumented rule to make those internal, which led to confusion.

**Before (0.3):**

```rust
#[derive(GodotClass)]
#[class(base=EditorPlugin)]
struct EditorMyPlugin {
    base: Base<EditorPlugin>,
}
```

**After (0.4):**

```rust
#[derive(GodotClass)]
#[class(base=EditorPlugin, internal)]
struct EditorMyPlugin {
    base: Base<EditorPlugin>,
}
```

[#1272]: https://github.com/godot-rust/gdext/pull/1272


## Engine APIs


### `EngineEnum` + `EngineBitfield` introspection

[#1232]: Since some enums in Godot contain duplicates, there isn't a unique name for an enum variant (which is just an integer internally).
Thus, `EngineEnum::godot_name()` sometimes returned incorrect names. The new API provides [`all_constants()`][api-enginenum-allconstants]
for a full introspection, and [`values()`][api-enginenum-values] for just distinct, useful values (e.g. when you need a drop-down list).

`EngineBitfield` also has [`all_constants()`][api-enginebitfield-allconstants] now, but no `values()`.

**Before (0.3):**

```rust
let name = MyEnum::Variant1.godot_name();
```

**After (0.4):**

```rust
let constants = MyEnum::all_constants();
// Use constants map to find names.
```

[#1232]: https://github.com/godot-rust/gdext/pull/1232
[api-enginenum-allconstants]: https://godot-rust.github.io/docs/gdext/master/godot/obj/trait.EngineEnum.html#tymethod.all_constants
[api-enginenum-values]: https://godot-rust.github.io/docs/gdext/master/godot/obj/trait.EngineEnum.html#tymethod.values
[api-enginebitfield-allconstants]: https://godot-rust.github.io/docs/gdext/master/godot/obj/trait.EngineBitfield.html#tymethod.all_constants


### Array and string indexing with negative values

[#1300]: Operations that support negative indexing (arrays, strings, etc.) now use [`SignedRange`][api-signedrange] instead of accepting raw integer
parameters.
This provides better type safety for range operations that can include negative indices.

**Before (0.3):**

```rust
let slice = array.slice(start, end); // Raw integers
```

**After (0.4):**

```rust
use godot::meta::wrapped;

let a = array.slice(wrapped(..-2));  // from 0 to len-2
let b = array.slice(wrapped(1..-2)); // from 1 to len-2
```

[#1300]: https://github.com/godot-rust/gdext/pull/1300

[api-signedrange]: https://godot-rust.github.io/docs/gdext/master/godot/meta/trait.SignedRange.html


Where possible and we consider it likely that the user named symbols in their own code, we provide deprecated aliases for the v0.4 cycle,
to ease the transition and provide helpful warnings.

[#1322]: https://github.com/godot-rust/gdext/pull/1322
[#1327]: https://github.com/godot-rust/gdext/pull/1327
[#1346]: https://github.com/godot-rust/gdext/pull/1346
